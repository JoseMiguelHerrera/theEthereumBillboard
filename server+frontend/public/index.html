<!doctype html>
<html>

<head>
    <title>bitscreen</title>
    <script src="contractdetails.js"></script>
    <script src="hashFuncs/bundle.js"></script>

    <script type="text/javascript">
        console.log("bitscreen contract address: " + bitscreenAddress)
        var bitscreen;


        window.addEventListener('load', function () {
            checkMetamask().then(() => {
                console.log("metamask ready")
                getContract().then(contract => {
                    bitscreen = contract;

                    bitscreen.currPicHash((err,resp)=>{
                        console.log(resp)
                        //THIS IS THE ACTUAL IPFS HASH FROM THE SMART CONTRACT!!!! WOW
                        document.getElementById("currHashSolidity").innerHTML = "Current IPFS image hash (from smart contract): " + hashFuncs.ipfsHashCompose(resp[0]);
                    })

                    bitscreen.screenstate((err,resp)=>{
                        document.getElementById("currScreenHolder").innerHTML = "Current holder of screen (from smart contract): " + resp[2];
                        document.getElementById("currDestination").innerHTML = "Current proposed destination of funds (from smart contract): " + resp[0];
                        document.getElementById("currLargestAmount").innerHTML = "Current largest amount sent (from smart contract): " + resp[1].toString();
                    })

                }).catch(err => {
                    alert(err)
                })
            }).catch(err => {
                alert(err)
            })
            getIpfState();
        })


        function checkMetamask() {
            return new Promise((resolve, reject) => {
                if (typeof web3 !== 'undefined') {
                    var provider = web3.currentProvider
                    web3.eth.getAccounts((err, accounts) => {
                        if (accounts.length === 0) {
                            reject("no account detected. please unlock metamask");
                        } else {
                            web3.eth.defaultAccount = accounts[0];
                            resolve();
                        }
                    });
                } else {
                    reject("bitscreen only works with MetaMask installed, please install before using!");
                }
            })
        }

        function getContract() {
            return new Promise((resolve, reject) => {
                var bitscreenContract = web3.eth.contract(bitscreenABI);
                var bitscreen = bitscreenContract.at(bitscreenAddress);

                if (bitscreen) {
                    resolve(bitscreen)
                } else {
                    reject("error getting contract")
                }

            })
        }

        function getIpfState() {
            //get curr img 
            fetch('/getCurr')
                .then((resp) => {
                    return resp.json()
                })
                .then(function (data) {
                    console.log("Current IPFS image hash (from server): " + data.hash)
                    document.getElementById("currHashServer").innerHTML = "Current IPFS image hash (from server): " + data.hash;
                    var arrayBufferView = new Uint8Array(data.pic.data);
                    //only works for png at the moment, since it is hard coded...
                    var blob = new Blob([arrayBufferView], { type: "image/png" })
                    var url = window.URL.createObjectURL(blob)
                    document.getElementById("currimg").src = url
                }).catch(function (error) {
                    console.log('Request failed', error);
                });
        }

        function sendnewpic() {
            console.log("change pic action")
            var file = document.getElementById('nextpic');
            if (file.files.length) {
                var reader = new FileReader();
                reader.readAsArrayBuffer(file.files[0])
                reader.onload = function (e) {
                    var sendform = new FormData(picform);
                    sendform.append("buffer", e.target.result)

                    fetch("/changePicture", {
                        body: sendform,
                        method: "post",
                    }).then((resp) => {
                        return resp.json()
                    }).then(json => {
                        getIpfState();
                        console.log(json)
                    }).catch(err => {
                        console.log(err)
                    })


                };
            }
            return false
        }




    </script>
</head>

<body>
    <h1>bitscreen v0.00000001</h1>

    <h2 id="currHashServer">Current IPFS image hash (from server): - </h2>
    <h2 id="currHashSolidity">Current IPFS image hash (from smart contract): - </h2>
    <h2 id="currScreenHolder">Current holder of screen (from smart contract): - </h2>
    <h2 id="currDestination">Current proposed destination of funds (from smart contract): - </h2>
    <h2 id="currLargestAmount">Current largest amount sent (from smart contract): - </h2>

    <br>
    <br>
    <br>


    <h2>Current image (from server hash): </h2>
    <img src="" id="currimg" />


    <h2>Change current image (to server): </h2>
    <form method="post" onsubmit="return sendnewpic()" enctype="multipart/form-data" id="picform">
        <div>
            <label for="changepic">Choose png pic to upload</label>
            <input type="file" id="nextpic" name="image" accept=".png">
        </div>
        <div>
            <button>Submit</button>
        </div>
    </form>

</body>

</html>