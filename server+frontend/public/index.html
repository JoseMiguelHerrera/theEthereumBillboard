<!doctype html>
<html>

<head>
    <title>bitscreen</title>
    <script src="contractdetails.js"></script>
    <script src="hashFuncs/bundle.js"></script>

    <script type="text/javascript">
        var bitscreen;
        var pollrate = 10;
        window.addEventListener('load', function () {
            checkMetamask().then(() => {
                console.log("metamask ready")
                getContract().then(contract => {
                    bitscreen = contract;
                    pollContract().then(() => {
                        document.getElementById("countdown").innerText = 0;
                    })

                    setInterval(function () {
                        pollContract().then(() => {
                            console.log("polled contract")
                            document.getElementById("countdown").innerText = 0;
                        })
                    }, pollrate * 1000)

                    setInterval(function () {
                        document.getElementById("countdown").innerText = parseInt(document.getElementById("countdown").innerText) + 1;
                    }, 1000);

                }).catch(err => {
                    alert(err)
                })
            }).catch(err => {
                alert(err)
            })
        })


        function checkMetamask() {
            return new Promise((resolve, reject) => {
                if (typeof web3 !== 'undefined') {
                    var provider = web3.currentProvider

                    web3.eth.getAccounts((err, accounts) => {
                        if (accounts.length === 0) {
                            reject("no account detected. please unlock metamask");
                        } else {
                            web3.eth.defaultAccount = accounts[0];
                            resolve();
                        }
                    });
                } else {
                    reject("bitscreen only works with MetaMask installed, please install before using!");
                }
            })
        }

        function getContract() {
            return new Promise((resolve, reject) => {
                var bitscreenContract = web3.eth.contract(bitscreenABI);
                var bitscreen = bitscreenContract.at(bitscreenAddress);

                if (bitscreen) {
                    resolve(bitscreen)
                } else {
                    reject("error getting contract")
                }

            })
        }


        function pollContract() {
            return new Promise((resolve, reject) => {
                bitscreen.currPicHash((err, resp) => {
                    if (err) {
                        reject(err)
                    } else {
                        var currHash = hashFuncs.ipfsHashCompose(resp[0])
                        displayHashPic(currHash);
                        document.getElementById("currHashSolidity").innerHTML = "Current IPFS image hash (from smart contract): " + currHash;
                        bitscreen.screenstate((err, resp) => {
                            if (err) {
                                reject(err)
                            } else {
                                document.getElementById("currScreenHolder").innerHTML = "Current holder of screen (from smart contract): " + resp[2];
                                document.getElementById("currDestination").innerHTML = "Current proposed destination of funds (from smart contract): " + resp[0];
                                document.getElementById("currLargestAmount").innerHTML = "Current largest amount sent [ether] (from smart contract): " + web3.fromWei(resp[1], 'ether');
                                resolve();
                            }
                        })
                    }
                })
            })
        }

        function displayHashPic(currHash) {
            //get curr img 
            fetch('/getIpfsObject', {
                body: JSON.stringify({ ipfsHash: currHash }),
                method: "POST",
                headers: new Headers({
                    'Content-Type': 'application/json'
                })
            }).then((resp) => {
                return resp.json()
            }).then(function (data) {
                var arrayBufferView = new Uint8Array(data.pic.data);
                //only works for png at the moment, since it is hard coded...
                var blob = new Blob([arrayBufferView], { type: "image/png" })
                var url = window.URL.createObjectURL(blob)
                document.getElementById("currimg").src = url
            }).catch(function (error) {
                console.log('Request failed', error);
            });
        }

        function sendnewpic() {
            console.log("change pic action")
            var file = document.getElementById('nextpic');
            if (file.files.length) {
                var reader = new FileReader();
                reader.readAsArrayBuffer(file.files[0])
                reader.onload = function (e) {
                    var sendform = new FormData(picform);
                    sendform.append("buffer", e.target.result)
                    fetch("/changePicture", {
                        body: sendform,
                        method: "post",
                    }).then((resp) => {
                        return resp.json()
                    }).then(json => {


                        //hardcoded an image for now
                        //check for amount
                        bitscreen.changeBid(
                            "0xc2624f9c42bdba1dd211b670b2ba10ef13c6a13d719f9eebcf199861d1d0f810",
                            18,
                            32,
                            "diabetes society",
                            { from: web3.eth.defaultAccount, value: web3.toWei(0.243, "ether"), gas: 1000000 },
                            function (err, result) { 
                                if(err){
                                    console.log("error doing tx")
                                    console.log(err)
                                }else{
                                    console.log(result)
                                }                                
                            });
                    }).catch(err => {
                        console.log(err)
                    })
                };
            }
            return false
        }
    </script>
</head>

<body>
    <h1>bitscreen alpha</h1>


    <h2>Seconds since last smart contract poll:
        <span id="countdown"></span>
    </h2>

    <h2 id="currHashSolidity">Current IPFS image hash (from smart contract): - </h2>
    <h2 id="currScreenHolder">Current holder of screen (from smart contract): - </h2>
    <h2 id="currDestination">Current proposed destination of funds (from smart contract): - </h2>
    <h2 id="currLargestAmount">Current largest amount sent (from smart contract): - </h2>

    <br>
    <br>
    <br>

    <h2>Current image (from smart contract hash): </h2>
    <img src="" id="currimg" />

    <h2>Change current image (to server): </h2>
    <form method="post" onsubmit="return sendnewpic()" enctype="multipart/form-data" id="picform">
        <div>
            <label for="changepic">Choose png pic to upload</label>
            <input type="file" id="nextpic" name="image" accept=".png">
        </div>
        <div>
            <button>Submit</button>
        </div>
    </form>

</body>

</html>